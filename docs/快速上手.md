# 快速上手

## 30 秒开始使用

### C++ CLI

```bash
cd E-Sift && mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
cmake --build . -j$(nproc)

./cudasift 0 1                               # 基本演示
./cudasift_txt 0 1 ../config/test_config.txt # 带配置
```

### Python

```python
import sys, cv2, numpy as np
sys.path.insert(0, "build/python")
import cuda_sift

config    = cuda_sift.SiftConfig("config/test_config.txt")
extractor = cuda_sift.SiftExtractor(config)
matcher   = cuda_sift.SiftMatcher()

img1 = cv2.imread("data/left.pgm", 0).astype(np.float32)
img2 = cv2.imread("data/righ.pgm", 0).astype(np.float32)

f1 = extractor.extract(img1)
f2 = extractor.extract(img2)

result = matcher.match_and_compute_homography(f1, f2)
print(f"匹配: {result['num_matches']}, 内点: {result['num_inliers']}")
```

---

## 三种匹配模式

### 速度优先（~3ms）

```python
result = matcher.match_and_compute_homography(
    f1, f2, use_improve=False
)
```

### 精度优先（~8ms）

```python
result = matcher.match_and_compute_homography(
    f1, f2, use_improve=True, improve_loops=5
)
```

### 分步调试

```python
matches    = matcher.match(f1, f2)
homography = matcher.compute_homography(matches, f1, f2)
```

---

## 返回数据格式

### 特征提取

```python
features = {
    "num_features":  1500,
    "keypoints":     np.ndarray,   # [N, 2] (x, y)
    "descriptors":   np.ndarray,   # [N, 128]
    "scales":        np.ndarray,   # [N]
    "orientations":  np.ndarray    # [N]
}
```

### 匹配 + 单应性

```python
result = {
    "num_matches":          1200,
    "matches":              np.ndarray,  # [N, 2]
    "match_score":          0.75,
    "homography":           np.ndarray,  # [3, 3]
    "num_inliers":          800,
    "num_refined_inliers":  750,         # 仅精度模式
    "score":                0.85
}
```

---

## 注意事项

1. **图像格式**: 必须是 `np.float32` 灰度图
2. **对象复用**: 不要在循环中反复创建 `SiftExtractor` / `SiftMatcher`
3. **GPU 内存**: 图像越大 + `max_features` 越大，显存占用越高
4. **配置文件**: 路径相对于运行目录，不是相对于可执行文件

---

## 常用代码片段

### 图像预处理

```python
def load_image(path):
    """加载图像为 SIFT 所需格式"""
    img = cv2.imread(path, cv2.IMREAD_GRAYSCALE)
    if img is None:
        raise FileNotFoundError(f"无法读取: {path}")
    return img.astype(np.float32)
```

### 结果校验

```python
def is_good_match(result, min_matches=50, min_inliers=20):
    return (result["num_matches"] >= min_matches and
            result["num_inliers"] >= min_inliers)
```

### 图像对齐

```python
H = result["homography"].astype(np.float64)
aligned = cv2.warpPerspective(img2_color, H, (w, h))
overlay = cv2.addWeighted(img1_color, 0.5, aligned, 0.5, 0)
```

---

## 在项目中集成 E-Sift

### 基于 CMake 集成（推荐）

```cmake
add_subdirectory(path/to/E-Sift)
target_link_libraries(your_target PRIVATE ESift::Core)
```

### 基于 Python 集成

```python
import sys, os
E_SIFT_ROOT = "/path/to/E-Sift"
sys.path.insert(0, os.path.join(E_SIFT_ROOT, "build/python"))
import cuda_sift
```

---

## 更多文档

| 文档 | 内容 |
|------|------|
| [构建指南](构建指南.md) | 各平台详细编译步骤 |
| [接口参考](接口参考.md) | C++ / Python API 完整说明 |
| [配置与调参](配置与调参.md) | 配置文件格式和参数调优建议 |
