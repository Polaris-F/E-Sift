# 配置与调参指南

## 配置文件格式

E-Sift 使用纯文本 `key = value` 格式的配置文件：

```ini
# 注释以 # 开头
dog_threshold = 3.0
num_octaves = 5
scale_up = false
```

配置文件位于 `config/` 目录，`cudasift_txt` 默认加载 `config/sift_config.txt`。

### 运行方式

```bash
# 使用默认配置
./cudasift_txt

# 指定 GPU + 图像集 + 配置文件
./cudasift_txt 0 1 config/test_config.txt
```

---

## 参数一览

### 核心算法参数

| 参数 | 范围 | 默认 | 说明 |
|------|------|------|------|
| `initial_blur` | 0.5–2.0 | 1.0 | 初始高斯模糊 sigma |
| `dog_threshold` | 1.0–10.0 | 1.3 | DoG 响应阈值，越高特征越少但质量越好 |
| `num_octaves` | 3–8 | 5 | 金字塔层数，越多检测越大尺度的特征 |
| `lowest_scale` | 0.0–2.0 | 0.0 | 最小检测尺度，0.0 = 全部尺度 |
| `edge_limit` | 5.0–20.0 | 10.0 | 边缘响应过滤阈值 |
| `scale_up` | true/false | false | 是否放大2×后处理（可检测更小特征，但更慢） |

### 匹配参数

| 参数 | 范围 | 默认 | 说明 |
|------|------|------|------|
| `min_score` | 0.0–1.0 | 0.85 | 最小匹配得分，越高越严格 |
| `max_ambiguity` | 0.0–1.0 | 0.95 | 最大歧义度，越低要求匹配越唯一 |

### 单应性参数

| 参数 | 范围 | 默认 | 说明 |
|------|------|------|------|
| `ransac_iterations` | 1000–50000 | 10000 | RANSAC 迭代次数 |
| `inlier_threshold` | 1.0–10.0 | 5.0 | 内点阈值（像素） |
| `optimization_iterations` | 1–20 | 5 | 单应性优化迭代次数 |
| `optimization_threshold` | 1.0–10.0 | 3.0 | 优化阈值 |

### 系统参数

| 参数 | 范围 | 默认 | 说明 |
|------|------|------|------|
| `max_features` | 4096–65536 | 32768 | 最大特征点容量 |
| `cuda_device` | 0+ | 0 | GPU 设备编号 |

### 输入/输出参数

| 参数 | 说明 |
|------|------|
| `image_set` | `0`:使用 jpg 图像对, `1`:使用 pgm 图像对 |
| `image1_path` | 主图像路径（image_set=0 时使用） |
| `image2_path` | 参考图像路径（image_set=0 时使用） |
| `alt_image1_path` | 备选图像路径（image_set=1 时使用） |
| `alt_image2_path` | 备选图像路径（image_set=1 时使用） |
| `verbose` | 是否输出详细信息 |
| `show_matches` | 是否启用可视化 |
| `output_path` | 可视化输出目录 |

---

## 参数效果总览

| 参数 | 增大效果 | 减小效果 |
|------|----------|----------|
| `dog_threshold` | 特征点减少，质量提高 | 特征点增加，可能引入噪声 |
| `num_octaves` | 检测更大尺度特征，更慢 | 速度快，大尺度特征漏检 |
| `initial_blur` | 图像更平滑，抗噪声 | 保留更多细节 |
| `min_score` | 匹配更严格，误匹配少 | 匹配更宽松 |
| `max_ambiguity` | 接受模糊匹配 | 要求匹配唯一性更高 |
| `edge_limit` | 保留更多边缘特征 | 过滤更多边缘响应 |
| `ransac_iterations` | 结果更稳定，更慢 | 速度快，可能不太稳定 |

---

## 场景配置推荐

### 高质量匹配（纹理丰富、光照良好）

```ini
dog_threshold = 3.0
num_octaves = 5
initial_blur = 1.0
min_score = 0.85
max_ambiguity = 0.95
ransac_iterations = 10000
max_features = 32768
scale_up = false
```

### 快速处理（实时应用）

```ini
dog_threshold = 4.0
num_octaves = 4
max_features = 16384
ransac_iterations = 5000
scale_up = false
```

### 低质量图像（模糊、噪声大）

```ini
dog_threshold = 4.5
num_octaves = 6
initial_blur = 1.5
edge_limit = 15.0
min_score = 0.80
ransac_iterations = 15000
scale_up = true
```

### 小目标检测

```ini
dog_threshold = 2.5
num_octaves = 6
initial_blur = 0.8
max_features = 32768
scale_up = true
lowest_scale = 0.0
```

---

## 调参步骤

### 第 1 步: 调整特征点数量

用默认配置运行，观察特征数：

- **太少 (<100)**: 降低 `dog_threshold`（3.0→2.5→2.0），增加 `num_octaves`，启用 `scale_up`
- **太多 (>10000)**: 提高 `dog_threshold`，减少 `max_features`

### 第 2 步: 调整匹配质量

观察匹配率和误匹配：

- **误匹配多**: 提高 `min_score`（0.85→0.90），降低 `max_ambiguity`（0.95→0.90）
- **正确匹配少**: 降低 `min_score`（0.85→0.80），增加 `ransac_iterations`

### 第 3 步: 优化性能

如果处理速度不够：

- 提高 `dog_threshold`
- 减少 `num_octaves` 和 `max_features`
- 减少 `ransac_iterations`
- 禁用 `scale_up`

---

## thresh 参数对性能的影响

在 1280×960 测试图像上的实测数据：

| thresh | 特征数 (左/右) | 匹配数 | 匹配率 |
|--------|---------------|--------|--------|
| 1.0 | ~10000 / ~12000 | ~4000 | ~40% |
| 3.0 | ~2100 / ~2700 | ~1600 | ~46% |
| 4.5 | ~1400 / ~2000 | ~680 | ~47% |

一般规律：
- 阈值越低，特征越多，但匹配率略低
- 阈值越高，特征越少但质量越高，匹配率更高
- 推荐从 3.0 开始，根据需求调整
