# 构建指南

## 环境要求

| 依赖 | 最低版本 | 推荐版本 | 说明 |
|------|---------|---------|------|
| CMake | 3.18 | 3.24+ | 3.24+ 支持 `native` GPU 自动检测 |
| CUDA Toolkit | 11.0 | 12.x | 需支持 C++17 |
| C++ 编译器 | GCC 9 / MSVC 2019 | GCC 11+ / MSVC 2022 | C++17 必需 |
| OpenCV | 4.0 | 4.x | `core`, `highgui`, `imgproc` 模块 |
| Python | 3.8 | 3.10+ | 仅在 `-DESIFT_BUILD_PYTHON=ON` 时需要 |

---

## Linux (x86_64)

```bash
# 安装依赖
sudo apt install build-essential cmake libopencv-dev

# 克隆 & 构建
git clone https://github.com/Polaris-F/E-Sift.git
cd E-Sift && mkdir build && cd build

cmake .. -DCMAKE_BUILD_TYPE=Release
cmake --build . -j$(nproc)

# 测试运行
./cudasift 0 1                                   # 基本演示
./cudasift_txt 0 1 ../config/test_config.txt     # 带配置+可视化
```

### 附加: 编译 Python 绑定

```bash
pip install pybind11

cmake .. -DCMAKE_BUILD_TYPE=Release -DESIFT_BUILD_PYTHON=ON
cmake --build . -j$(nproc)

# 验证
python3 -c "import sys; sys.path.insert(0,'python'); import cuda_sift; print('OK')"
```

---

## Linux (Jetson / aarch64)

Jetson 设备需要指定较小的线程块高度以避免超出 1024 线程限制：

```bash
mkdir build && cd build

cmake .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DSCALEDOWN_H=8 \
  -DCMAKE_CUDA_ARCHITECTURES=87    # Orin=87, Xavier=72, Nano=53

cmake --build . -j4
```

---

## Windows (MSVC)

### 方案 A: Visual Studio IDE

1. 安装 Visual Studio 2019/2022（含 C++ 桌面开发 + CUDA 工具集）
2. 安装 CUDA Toolkit
3. 安装 OpenCV（通过 vcpkg 或预编译包）

```powershell
mkdir build; cd build

cmake .. -DCMAKE_BUILD_TYPE=Release `
  -DOpenCV_DIR=C:/path/to/opencv/build

cmake --build . --config Release
```

### 方案 B: VS Build Tools + conda（轻量级）

适合没有完整 VS IDE 的环境：

```powershell
# 1. 创建 conda 环境
conda create -n esift python=3.10
conda activate esift
conda install -c nvidia cuda-toolkit=12.6
conda install -c conda-forge libopencv

# 2. 准备构建环境（需要 VS Build Tools + Windows SDK）
#    在 Developer Command Prompt 中执行：
vcvarsall.bat x64

# 3. 设置 conda CUDA 路径
set CUDA_PATH=%CONDA_PREFIX%\Library
set PATH=%CONDA_PREFIX%\Library\bin;%PATH%

# 4. 配置 & 编译
cd E-Sift\build
cmake .. -G Ninja ^
    -DCMAKE_C_COMPILER=cl ^
    -DCMAKE_CXX_COMPILER=cl ^
    -DCMAKE_CUDA_COMPILER=%CONDA_PREFIX%\Library\bin\nvcc.exe ^
    -DCMAKE_BUILD_TYPE=Release ^
    -DESIFT_BUILD_CLI=ON ^
    -DOpenCV_DIR=%CONDA_PREFIX%\Library\cmake ^
    -DCMAKE_CUDA_ARCHITECTURES=75

cmake --build . --config Release
```

> **注意**: 需要先运行 `vcvarsall.bat x64` 初始化 MSVC 编译环境后再执行 cmake。

---

## CMake 选项一览

| 选项 | 默认值 | 说明 |
|------|--------|------|
| `ESIFT_BUILD_CLI` | `ON` | 编译 `cudasift` 和 `cudasift_txt` 可执行文件 |
| `ESIFT_BUILD_PYTHON` | `OFF` | 编译 Python 绑定（需要 pybind11） |
| `ESIFT_BUILD_SHARED` | `OFF` | 将 `esift_core` 编译为动态库 |
| `ESIFT_VERBOSE` | `OFF` | 启用内核计时输出 |
| `CMAKE_CUDA_ARCHITECTURES` | `native` | 目标 GPU 架构，如 `75`(Turing), `86`(Ampere), `87`(Orin) |
| `SCALEDOWN_H` | *空 → 16* | ScaleDown 线程块高度；Jetson 设为 `8` |

```bash
# 示例: Jetson Orin
cmake .. -DCMAKE_CUDA_ARCHITECTURES=87 -DSCALEDOWN_H=8

# 示例: RTX 4090
cmake .. -DCMAKE_CUDA_ARCHITECTURES=89
```

---

## 构建产物

| 文件 | 说明 |
|------|------|
| `esift_core.lib` / `libesift_core.a` | 核心静态库 |
| `cudasift` / `cudasift.exe` | 基本 SIFT 演示程序 |
| `cudasift_txt` / `cudasift_txt.exe` | 可配置 SIFT + 可视化 |
| `python/cuda_sift*.so` / `.pyd` | Python 扩展模块（可选） |

---

## 常见问题

### CMake 找不到 CUDA

```bash
# 确认 nvcc 在 PATH 中
nvcc --version

# 或手动指定
cmake .. -DCMAKE_CUDA_COMPILER=/usr/local/cuda/bin/nvcc
```

### CMake 找不到 OpenCV

```bash
cmake .. -DOpenCV_DIR=/path/to/opencv/build
```

### 运行时 CUDA illegal memory access

通常是 `SCALEDOWN_H` 与 GPU 架构不匹配。确保编译时指定了正确的 `CMAKE_CUDA_ARCHITECTURES`。

### Windows: nvcc 收到 MSVC 专用 flag

已在 CMakeLists.txt 中通过 generator expressions 修复。如仍有问题，确认使用的是最新版 CMakeLists.txt。

### Python: ImportError

```bash
# 确认编译时开启了 Python 绑定
cmake .. -DESIFT_BUILD_PYTHON=ON

# 确认路径正确
python -c "import sys; sys.path.insert(0, 'build/python'); import cuda_sift"
```
